# Set seed for reproducibility
set.seed(808)

# Parameters
n_respondents <- 100  # Number of respondents
n_items <- 100       # Number of items
options <- c("A", "B", "C", "D")  # Response options
n_misfit <- 8        # Number of respondents who misfit the Rasch model
n_dif_items <- 20    # Number of items with DIF (5 per domain)

# Define domain structure and DIF items
domains <- rep(c("Domain1", "Domain2", "Domain3", "Domain4"), each = 25)
item_names <- paste0("Item", 1:n_items)
dif_items <- c(sample(1:25, 5), sample(26:50, 5), sample(51:75, 5), sample(76:100, 5))  # 5 DIF items per domain

# Create gender variable (Male/Female, balanced)
gender <- sample(c("Male", "Female"), n_respondents, replace = TRUE, prob = c(0.5, 0.5))

# Simulate respondent abilities (theta) and item difficulties (beta)
theta <- rnorm(n_respondents, mean = 0, sd = 1)  # Respondent abilities (logit scale)
beta <- rnorm(n_items, mean = 0, sd = 1)        # Base item difficulties (logit scale)

# Introduce DIF: Adjust item difficulties for Female group
beta_female <- beta
dif_effect <- 1.0  # DIF effect size (logit scale, Female group has higher difficulty for DIF items)
beta_female[dif_items] <- beta[dif_items] + dif_effect  # Increase difficulty for Females on DIF items

# Create a matrix to store responses
dataset <- matrix(NA, nrow = n_respondents, ncol = n_items)

# Generate Rasch model responses (A is correct, others incorrect)
for (i in 1:n_items) {
  for (j in 1:n_respondents) {
    # Select appropriate difficulty based on gender
    beta_current <- ifelse(gender[j] == "Female", beta_female[i], beta[i])
    # Rasch model probability of correct response
    p_correct <- 1 / (1 + exp(-(theta[j] - beta_current)))
    # Probability of selecting each option (A is correct)
    probs <- c(p_correct, (1 - p_correct) / 3, (1 - p_correct) / 3, (1 - p_correct) / 3)
    dataset[j, i] <- sample(options, 1, prob = probs)
  }
}

# Introduce misfit for 8 respondents
misfit_indices <- sample(1:n_respondents, n_misfit)
for (j in misfit_indices) {
  # Create aberrant response patterns (random guessing for 50% of items)
  random_items <- sample(1:n_items, n_items * 0.5)
  dataset[j, random_items] <- sample(options, length(random_items), replace = TRUE, prob = rep(0.25, 4))
}

# Convert to data frame and add gender
dataset <- as.data.frame(dataset)
colnames(dataset) <- item_names
dataset$Gender <- gender

# Create item info data frame
item_info <- data.frame(
  Item = item_names,
  Domain = domains,
  DIF = ifelse(1:n_items %in% dif_items, "Yes", "No")
)

# Save dataset and item info to CSV
write.csv(dataset, "rasch_dif_dataset.csv", row.names = FALSE)
write.csv(item_info, "rasch_dif_item_info.csv", row.names = FALSE)

# Display first few rows
head(dataset[, c(1:10, ncol(dataset))])  # Show first 10 items and Gender

# Display summary of responses and gender
summary(dataset)

# Convert to binary for Rasch analysis (A = 1, others = 0)
binary_dataset <- as.data.frame(lapply(dataset[, 1:n_items], function(x) ifelse(x == "A", 1, 0)))

# Basic Rasch analysis using the eRm package
if (!require(eRm)) install.packages("eRm")
library(eRm)

# Fit Rasch model
rasch_model <- RM(binary_dataset)

# Person fit analysis (infit and outfit statistics)
person_fit <- personfit(rasch_model)
infit_msq <- person_fit$p.infitMSQ
outfit_msq <- person_fit$p.outfitMSQ

# Identify misfitting respondents (infit/outfit MSQ > 1.5 or < 0.5)
misfit_persons <- which(infit_msq > 1.5 | infit_msq < 0.5 | outfit_msq > 1.5 | outfit_msq < 0.5)
cat("Number of misfitting respondents:", length(misfit_persons), "\n")
cat("Misfitting respondent indices:", misfit_persons, "\n")

# Item difficulties
item_diff <- rasch_model$betapar
cat("Item Difficulties (first 10):\n")
print(head(-item_diff, 10))  # Negative for conventional difficulty interpretation

# Domain score summaries (sum of correct responses per domain)
domain_scores <- data.frame(
  Domain1 = rowSums(binary_dataset[, 1:25]),
  Domain2 = rowSums(binary_dataset[, 26:50]),
  Domain3 = rowSums(binary_dataset[, 51:75]),
  Domain4 = rowSums(binary_dataset[, 76:100])
)
cat("Domain Score Summaries:\n")
summary(domain_scores)

# DIF analysis using lordif package
if (!require(lordif)) install.packages("lordif")
library(lordif)

# Run DIF analysis (logistic regression approach)
dif_analysis <- lordif(binary_dataset, group = dataset$Gender, criterion = "Chisqr")
cat("Items with DIF (based on lordif):\n")
print(dif_analysis$stats[dif_analysis$stats$flag, ])

# Plot DIF for a sample DIF item
if (length(dif_items) > 0) {
  plot(dif_analysis, item = dif_items[1], main = paste("DIF Plot for Item", dif_items[1]))
}
